<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Focus Group Wizard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', 'Inter Fallback'; background: #fff; }
    .gradient-bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      background: linear-gradient(120deg, #a1c4fd 0%, #fbc2eb 50%, #f9ea8f 100%);
      filter: blur(40px) saturate(140%);
      opacity: 0.95;
      pointer-events: none;
    }
    .noise-bg {
      position: fixed;
      inset: 0;
      z-index: 1;
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+Xn1cAAAAASUVORK5CYII=');
      opacity: 0.18;
      pointer-events: none;
      mix-blend-mode: soft-light;
    }
    .glass-card {
      position: relative;
      border-radius: 1.5rem;
      background: rgba(255,255,255,0.25);
      box-shadow: 0 8px 32px 0 rgba(31,38,135,0.10);
      border: 1.5px solid rgba(255, 255, 255, 0.22);
      overflow: hidden;
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      transition: box-shadow 0.2s;
    }
    .glass-card:hover {
      box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.18);
    }
    .sidebar-collapsed { width: 4rem !important; }
    .sidebar-expanded { width: 16rem !important; }
    .sidebar { transition: width 0.2s; }
    .chatbox { min-width: 320px; max-width: 400px; height: 80vh; display: flex; flex-direction: column; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 1rem; }
    .chat-input { border-top: 1px solid #eee; padding: 0.75rem; display: flex; gap: 0.5rem; }
    .send-btn { background: #6366f1; color: #fff; border: none; border-radius: 0.5rem; padding: 0 1rem; font-weight: 600; transition: background 0.2s; }
    .send-btn:hover { background: #4338ca; }
    .wizard-step { display: none; }
    .wizard-step.active { display: block; }
    .sidebar-collapsed .sidebar-label { display: none !important; }
    .sidebar-collapsed .sidebar-icon { display: inline-block !important; }
    .sidebar-expanded .sidebar-label { display: inline-block !important; }
    .sidebar-expanded .sidebar-icon { display: inline-block !important; }
    
    /* Chroma gradient backgrounds */
    .chroma-focus-group {
      background: linear-gradient(135deg, #7f5af0 0%, #00c6fb 100%);
      background-size: 200% 200%;
      animation: chroma-move 6s ease-in-out infinite;
      position: relative;
      overflow: hidden;
    }
    .chroma-polling {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      background-size: 200% 200%;
      animation: chroma-move 6s ease-in-out infinite;
      position: relative;
      overflow: hidden;
    }
    .chroma-test-content {
      background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
      background-size: 200% 200%;
      animation: chroma-move 6s ease-in-out infinite;
      position: relative;
      overflow: hidden;
    }
    
    @keyframes chroma-move {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* Audience card selection states */
    .audience-card {
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .audience-card.selected {
      transform: scale(1.02);
      box-shadow: 0 20px 40px 0 rgba(31, 38, 135, 0.25);
      border: 2px solid rgba(99, 102, 241, 0.5);
    }
    
    .audience-card.selected::before {
      content: '‚úì';
      position: absolute;
      top: 10px;
      right: 10px;
      background: #6366f1;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }
  </style>
</head>
<body class="min-h-screen flex bg-white">
  <div class="gradient-bg"></div>
  <div class="noise-bg"></div>
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar sidebar-expanded bg-white/80 shadow-lg flex flex-col py-8 px-4 min-h-screen border-r border-gray-200 backdrop-blur-md z-10">
    <button onclick="toggleSidebar()" class="mb-8 text-gray-500 hover:text-indigo-400 focus:outline-none">
      <span id="sidebar-toggle" class="text-2xl">&#9776;</span>
    </button>
    <nav class="flex-1 space-y-4">
      <a href="/" class="flex items-center gap-3 text-lg font-semibold text-indigo-400">
        <span class="sidebar-icon">üè†</span>
        <span class="sidebar-label">Home</span>
      </a>
      <span class="flex items-center gap-3 text-lg text-gray-500 cursor-default">
        <span class="sidebar-icon">üë•</span>
        <span class="sidebar-label">Audiences</span>
      </span>
      <a href="/data.html" class="flex items-center gap-3 text-lg text-gray-500">
        <span class="sidebar-icon">üìä</span>
        <span class="sidebar-label">Data</span>
      </a>
      <span class="flex items-center gap-3 text-lg text-gray-500 cursor-default">
        <span class="sidebar-icon">üìÑ</span>
        <span class="sidebar-label">Transcripts</span>
      </span>
      <span class="flex items-center gap-3 text-lg text-gray-500 cursor-default">
        <span class="sidebar-icon">‚ùì</span>
        <span class="sidebar-label">FAQs</span>
      </span>
    </nav>
  </aside>
  <!-- Main Content -->
  <main class="flex-1 flex flex-col items-center justify-between py-12 px-6 gap-8 relative z-10" style="min-height: 80vh;">
    <!-- Wizard Steps (top) -->
    <div class="w-full max-w-6xl mx-auto" style="flex: 0 0 auto;">
      <!-- Step 1: Choose Audience (Full Page) -->
      <div class="glass-card wizard-step active p-10 mb-8" id="step-1">
        <h2 class="text-3xl font-bold mb-8 text-center">Choose your audience</h2>
        
        <!-- Audience Selection Grid - All tiles same size -->
        <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 mb-8">
          <!-- Young Professionals -->
          <div class="audience-card glass-card p-6 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl h-32 flex items-center justify-center" onclick="selectAudience('Young Professionals')">
            <div class="text-center">
              <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mb-3 mx-auto">
                <span class="text-indigo-600 font-bold text-lg">YP</span>
              </div>
              <h3 class="text-base font-semibold">Young Professionals</h3>
            </div>
            <input type="radio" name="audience" value="Young Professionals" class="hidden" checked>
          </div>
          
          <!-- Parents with Young Children -->
          <div class="audience-card glass-card p-6 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl h-32 flex items-center justify-center" onclick="selectAudience('Parents with Young Children')">
            <div class="text-center">
              <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-3 mx-auto">
                <span class="text-blue-600 font-bold text-lg">P</span>
              </div>
              <h3 class="text-base font-semibold">Parents with Young Children</h3>
            </div>
            <input type="radio" name="audience" value="Parents with Young Children" class="hidden">
          </div>
          
          <!-- Retirees -->
          <div class="audience-card glass-card p-6 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl h-32 flex items-center justify-center" onclick="selectAudience('Retirees')">
            <div class="text-center">
              <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-3 mx-auto">
                <span class="text-green-600 font-bold text-lg">R</span>
              </div>
              <h3 class="text-base font-semibold">Retirees</h3>
            </div>
            <input type="radio" name="audience" value="Retirees" class="hidden">
          </div>
          
          <!-- UK Retail Audiences -->
          <div class="audience-card glass-card p-6 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl h-32 flex items-center justify-center" onclick="selectAudience('UK Retail Audiences')">
            <div class="text-center">
              <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-3 mx-auto">
                <span class="text-purple-600 font-bold text-lg">UK</span>
              </div>
              <h3 class="text-base font-semibold">UK Retail Audiences</h3>
            </div>
            <input type="radio" name="audience" value="UK Retail Audiences" class="hidden">
          </div>
          
          <!-- Manchester -->
          <div class="audience-card glass-card p-6 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl h-32 flex items-center justify-center" onclick="selectAudience('Manchester')">
            <div class="text-center">
              <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-3 mx-auto">
                <span class="text-red-600 font-bold text-lg">M</span>
              </div>
              <h3 class="text-base font-semibold">Manchester</h3>
            </div>
            <input type="radio" name="audience" value="Manchester" class="hidden">
          </div>
          
          <!-- Birmingham -->
          <div class="audience-card glass-card p-6 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl h-32 flex items-center justify-center" onclick="selectAudience('Birmingham')">
            <div class="text-center">
              <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mb-3 mx-auto">
                <span class="text-orange-600 font-bold text-lg">B</span>
              </div>
              <h3 class="text-base font-semibold">Birmingham</h3>
            </div>
            <input type="radio" name="audience" value="Birmingham" class="hidden">
          </div>
          
          <!-- Liverpool -->
          <div class="audience-card glass-card p-6 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl h-32 flex items-center justify-center" onclick="selectAudience('Liverpool')">
            <div class="text-center">
              <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mb-3 mx-auto">
                <span class="text-yellow-600 font-bold text-lg">L</span>
              </div>
              <h3 class="text-base font-semibold">Liverpool</h3>
            </div>
            <input type="radio" name="audience" value="Liverpool" class="hidden">
          </div>
          
          <!-- London -->
          <div class="audience-card glass-card p-6 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl h-32 flex items-center justify-center" onclick="selectAudience('London')">
            <div class="text-center">
              <div class="w-12 h-12 bg-pink-100 rounded-full flex items-center justify-center mb-3 mx-auto">
                <span class="text-pink-600 font-bold text-lg">L</span>
              </div>
              <h3 class="text-base font-semibold">London</h3>
            </div>
            <input type="radio" name="audience" value="London" class="hidden">
          </div>
          
          <!-- Leeds -->
          <div class="audience-card glass-card p-6 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl h-32 flex items-center justify-center" onclick="selectAudience('Leeds')">
            <div class="text-center">
              <div class="w-12 h-12 bg-teal-100 rounded-full flex items-center justify-center mb-3 mx-auto">
                <span class="text-teal-600 font-bold text-lg">L</span>
              </div>
              <h3 class="text-base font-semibold">Leeds</h3>
            </div>
            <input type="radio" name="audience" value="Leeds" class="hidden">
          </div>
          
          <!-- Newcastle -->
          <div class="audience-card glass-card p-6 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl h-32 flex items-center justify-center" onclick="selectAudience('Newcastle')">
            <div class="text-center">
              <div class="w-12 h-12 bg-cyan-100 rounded-full flex items-center justify-center mb-3 mx-auto">
                <span class="text-cyan-600 font-bold text-lg">N</span>
              </div>
              <h3 class="text-base font-semibold">Newcastle</h3>
            </div>
            <input type="radio" name="audience" value="Newcastle" class="hidden">
          </div>
          
          <!-- Cardiff -->
          <div class="audience-card glass-card p-6 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl h-32 flex items-center justify-center" onclick="selectAudience('Cardiff')">
            <div class="text-center">
              <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center mb-3 mx-auto">
                <span class="text-emerald-600 font-bold text-lg">C</span>
              </div>
              <h3 class="text-base font-semibold">Cardiff</h3>
            </div>
            <input type="radio" name="audience" value="Cardiff" class="hidden">
          </div>
          
          <!-- Oxford -->
          <div class="audience-card glass-card p-6 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl h-32 flex items-center justify-center" onclick="selectAudience('Oxford')">
            <div class="text-center">
              <div class="w-12 h-12 bg-violet-100 rounded-full flex items-center justify-center mb-3 mx-auto">
                <span class="text-violet-600 font-bold text-lg">O</span>
              </div>
              <h3 class="text-base font-semibold">Oxford</h3>
            </div>
            <input type="radio" name="audience" value="Oxford" class="hidden">
          </div>
          
          <!-- Norwich -->
          <div class="audience-card glass-card p-6 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl h-32 flex items-center justify-center" onclick="selectAudience('Norwich')">
            <div class="text-center">
              <div class="w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center mb-3 mx-auto">
                <span class="text-rose-600 font-bold text-lg">N</span>
              </div>
              <h3 class="text-base font-semibold">Norwich</h3>
            </div>
            <input type="radio" name="audience" value="Norwich" class="hidden">
          </div>
        </div>
        
        <!-- City Info Panel -->
        <div id="city-info" class="hidden mb-8">
          <div class="glass-card p-8 border border-blue-200/50">
            <h3 class="font-semibold text-blue-800 mb-4 text-xl" id="city-info-title">City Data</h3>
            <div class="text-base text-blue-700 space-y-3" id="city-info-content">
              <!-- City data will be populated by JavaScript -->
      </div>
          </div>
        </div>
        
        <div class="flex justify-center">
          <button class="px-8 py-4 bg-indigo-500 text-white rounded-lg font-semibold text-lg shadow hover:bg-indigo-600 transition" onclick="nextStep(2)">Continue</button>
        </div>
      </div>
      
      <!-- Step 2: Configuration -->
      <div class="wizard-step mb-8" id="step-2">
        <h2 class="text-2xl font-bold mb-6 text-center">Want to tweak how it runs?</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          <!-- Configuration Options - Left Glass Tile -->
          <div class="glass-card p-8">
            <h3 class="text-xl font-semibold mb-6 text-indigo-700">Configuration Settings</h3>
            <div class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Group Size</label>
                <select id="group-size" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" onchange="checkConfigurationComplete()">
                  <option value="3">3 participants</option>
                  <option value="4">4 participants</option>
                  <option value="5" selected>5 participants</option>
                  <option value="6">6 participants</option>
                  <option value="7">7 participants</option>
                  <option value="8">8 participants</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Number of Questions</label>
                <select id="question-count" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" onchange="checkConfigurationComplete()">
                  <option value="3">3 questions</option>
                  <option value="4">4 questions</option>
                  <option value="5" selected>5 questions</option>
                  <option value="6">6 questions</option>
                  <option value="7">7 questions</option>
                  <option value="8">8 questions</option>
                </select>
              </div>
              
              <div class="flex items-center">
                <input type="checkbox" id="open-discussion" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" onchange="checkConfigurationComplete()">
                <label for="open-discussion" class="ml-3 text-sm text-gray-700">
                  Enable open discussion
            </label>
              </div>
              <p class="text-sm text-gray-500 ml-7">Allow participants to continue talking after the initial session ends.</p>
            </div>
          </div>
          
          <!-- Questions Section - Right Glass Tile (Initially Hidden) -->
          <div id="questions-section" class="glass-card p-6 flex flex-col hidden" style="height: 400px;">
            <h3 class="text-xl font-semibold mb-4 text-indigo-700">What questions do you want to ask?</h3>
            <div class="flex-1 space-y-4">
              <form class="flex gap-2" onsubmit="addQuestion(); return false;">
                <input type="text" id="question-input" class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Type your question..." autocomplete="off">
                <button type="submit" class="send-btn px-4 py-2 rounded-lg">Add</button>
              </form>
              <div class="flex-1 overflow-y-auto">
                <ul id="questions-list" class="space-y-2"></ul>
              </div>
            </div>
          </div>
          
          <!-- Placeholder - Right Glass Tile (Initially Visible) -->
          <div id="placeholder-section" class="glass-card p-6 flex flex-col items-center justify-center" style="height: 400px;">
            <div class="text-center text-gray-500">
              <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                <span class="text-gray-400 text-2xl">?</span>
              </div>
              <h3 class="text-lg font-semibold mb-2">Complete Configuration</h3>
              <p class="text-sm">Select group size, number of questions, and open discussion option to start adding questions.</p>
            </div>
          </div>
        </div>
        
        <div class="flex gap-4 justify-center">
          <button class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold text-lg shadow hover:bg-gray-300 transition" onclick="nextStep(1)">Back</button>
          <button id="next-button" class="px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold text-lg shadow transition cursor-not-allowed" disabled onclick="nextStep(3)">Next</button>
        </div>
      </div>
      
      <!-- Step 3: Launch -->
      <div class="glass-card wizard-step p-10 mb-8" id="step-3">
        <h2 class="text-2xl font-bold mb-4">All set! Ready to launch?</h2>
        <div class="flex gap-4">
          <button class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold text-lg shadow hover:bg-gray-300 transition" onclick="nextStep(2)">Back</button>
          <button id="launch-btn" class="px-6 py-3 bg-green-500 text-white rounded-lg font-semibold text-lg shadow hover:bg-green-600 transition" onclick="launchFocusGroup()">Launch Focus Group</button>
        </div>
        <div id="launch-loading" class="mt-4 text-gray-500 hidden flex flex-col items-center">
          <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-500 mb-2"></div>
          <span>Launching focus group, please wait...</span>
        </div>
      </div>
    </div>
  </main>
  <script>
    // Global chat messages array for true chat rendering
    let chatMessagesArray = [];

    // Sidebar toggle
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('sidebar-collapsed');
      sidebar.classList.toggle('sidebar-expanded');
    }
    
    // Select audience and handle card selection
    function selectAudience(audienceName) {
      // Remove selected class from all cards
      document.querySelectorAll('.audience-card').forEach(card => {
        card.classList.remove('selected');
      });
      
      // Add selected class to clicked card
      const selectedCard = event.currentTarget;
      selectedCard.classList.add('selected');
      
      // Set the audience ID for the API call
      selectedCard.dataset.audienceId = audienceName;
      
      // Update radio button
      const radioButton = selectedCard.querySelector('input[type="radio"]');
      radioButton.checked = true;
      
      // Show city info if it's a city audience
      const cityNames = ['Manchester', 'Birmingham', 'Liverpool', 'London', 'Leeds', 'Newcastle', 'Cardiff', 'Oxford', 'Norwich'];
      if (cityNames.includes(audienceName)) {
        showCityInfo(audienceName);
      } else {
        // Hide city info for non-city audiences
        document.getElementById('city-info').classList.add('hidden');
      }
    }
    
    // Show city information
    function showCityInfo(cityName) {
      const cityInfo = document.getElementById('city-info');
      const cityInfoTitle = document.getElementById('city-info-title');
      const cityInfoContent = document.getElementById('city-info-content');

      const cityData = {
        'Manchester': {
          title: 'Manchester City Data',
          population: '586,100 (2021)',
          employment: '71.4%',
          weeklyPay: '¬£580',
          artsEngagement: '68%',
          museumVisits: '45%'
        },
        'Birmingham': {
          title: 'Birmingham City Data',
          population: '1,157,603 (2022)',
          employment: '65.9%',
          weeklyPay: '¬£520',
          artsEngagement: '72%',
          museumVisits: '38%'
        },
        'Liverpool': {
          title: 'Liverpool City Data',
          population: '495,849 (2022)',
          employment: '67.5%',
          weeklyPay: '¬£540',
          artsEngagement: '75%',
          museumVisits: '52%'
        },
        'London': {
          title: 'London City Data',
          population: '8,982,000 (2022)',
          employment: '75.2%',
          weeklyPay: '¬£720',
          artsEngagement: '92%',
          museumVisits: '78%'
        },
        'Leeds': {
          title: 'Leeds City Data',
          population: '789,000 (2022)',
          employment: '69.8%',
          weeklyPay: '¬£560',
          artsEngagement: '70%',
          museumVisits: '42%'
        },
        'Newcastle': {
          title: 'Newcastle City Data',
          population: '322,000 (2022)',
          employment: '68.1%',
          weeklyPay: '¬£540',
          artsEngagement: '73%',
          museumVisits: '48%'
        },
        'Cardiff': {
          title: 'Cardiff City Data',
          population: '481,000 (2022)',
          employment: '70.3%',
          weeklyPay: '¬£550',
          artsEngagement: '71%',
          museumVisits: '44%'
        },
        'Oxford': {
          title: 'Oxford City Data',
          population: '162,000 (2022)',
          employment: '72.6%',
          weeklyPay: '¬£620',
          artsEngagement: '85%',
          museumVisits: '65%'
        },
        'Norwich': {
          title: 'Norwich City Data',
          population: '213,000 (2022)',
          employment: '71.9%',
          weeklyPay: '¬£530',
          artsEngagement: '69%',
          museumVisits: '41%'
        }
      };

      if (cityData[cityName]) {
        const data = cityData[cityName];
        cityInfoTitle.textContent = data.title;
        cityInfoContent.innerHTML = `
          <p><strong>Population:</strong> ${data.population}</p>
          <p><strong>Employment Rate:</strong> ${data.employment}</p>
          <p><strong>Median Weekly Pay:</strong> ${data.weeklyPay}</p>
          <p><strong>Arts Engagement:</strong> ${data.artsEngagement}</p>
          <p><strong>Museum Visits:</strong> ${data.museumVisits}</p>
        `;
        cityInfo.classList.remove('hidden');
      } else {
        cityInfo.classList.add('hidden');
      }
    }
    
    // Wizard navigation
    function nextStep(step) {
      // Hide all steps
      document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
      // Show target step
      document.getElementById(`step-${step}`).classList.add('active');
    }
    
    // Add question to list
    function addQuestion() {
      const input = document.getElementById('question-input');
      const question = input.value.trim();
      if (question) {
        const list = document.getElementById('questions-list');
      const li = document.createElement('li');
        li.className = 'flex items-center justify-between p-3 bg-gray-50 rounded';
      li.innerHTML = `
        <span>${question}</span>
          <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700">Remove</button>
      `;
        list.appendChild(li);
      input.value = '';
      }
    }
    
    // Send chat message
    function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (message) {
        const messages = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = 'mb-4';
        div.innerHTML = `
          <span class="font-semibold text-gray-600">You:</span> 
          <span class="text-gray-700">${message}</span>
        `;
        messages.appendChild(div);
        input.value = '';
        messages.scrollTop = messages.scrollHeight;
      }
    }
    
    // Launch focus group
    async function launchFocusGroup() {
      const loading = document.getElementById('launch-loading');
      const button = document.getElementById('launch-btn');
      
      // Get form data
      const selectedAudience = document.querySelector('.audience-card.selected')?.dataset.audienceId;
      const groupSize = document.getElementById('group-size').value;
      const questionCount = document.getElementById('question-count').value;
      const openDiscussion = document.getElementById('open-discussion').checked;
      const customQuestions = Array.from(document.querySelectorAll('#questions-list li span'))
        .map(span => span.textContent.trim())
        .filter(q => q);
      
      if (!selectedAudience) {
        alert('Please select an audience first');
        return;
      }
      
      loading.classList.remove('hidden');
      button.disabled = true;
      button.textContent = 'Launching...';
      
      try {
        const response = await fetch('/api/focus_group/simulate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            audience_id: selectedAudience,
            group_size: parseInt(groupSize),
            questions: customQuestions.length > 0 ? customQuestions : ['What are your thoughts on this topic?'],
            open_discussion: openDiscussion
          })
        });
        
        const result = await response.json();
        
        if (response.ok && result.status === 'success') {
          // Show results
          displayFocusGroupResults(result);
        } else {
          throw new Error(result.error || 'Failed to launch focus group');
        }
      } catch (error) {
        console.error('Error launching focus group:', error);
        alert('Error launching focus group: ' + error.message);
      } finally {
        loading.classList.add('hidden');
        button.disabled = false;
        button.textContent = 'Launch Focus Group';
      }
    }
    
    // Render chat messages using glassmorphism bubbles
    function renderChatMessages() {
      const chatMessagesDiv = document.getElementById('chat-messages');
      chatMessagesDiv.innerHTML = chatMessagesArray.map(msg => {
        if (msg.type === 'moderator') {
          return `
            <div class="flex items-start space-x-3 mb-4">
              <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-400 to-cyan-400 flex items-center justify-center text-white font-bold text-sm">M</div>
              <div class="flex-1">
                <div class="bg-white/30 backdrop-blur-md rounded-xl p-3 shadow-lg border border-white/30">
                  <div class="font-semibold text-sm text-blue-700 mb-1">Moderator${msg.isStimulus ? ' ‚Ä¢ Initial Stimulus' : ` ‚Ä¢ Question ${msg.round_number}`}</div>
                  <div class="text-gray-900 font-medium">${msg.text}</div>
                </div>
              </div>
            </div>
          `;
        } else {
                     return `
             <div class="flex items-start space-x-3 mb-4 ml-8">
               <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-400 to-pink-400 flex items-center justify-center text-white font-bold text-sm">P</div>
               <div class="flex-1">
                 <div class="backdrop-blur-md rounded-xl p-3 shadow border border-white/30">
                   <div class="font-semibold text-sm text-black mb-1">Participant ${msg.participant}</div>
                   <div class="text-black">${msg.text}</div>
                   ${msg.sentiment ? `<div class="text-xs text-gray-600 mt-1">Sentiment: ${msg.sentiment}</div>` : ''}
                 </div>
               </div>
             </div>
           `;
        }
      }).join('');
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    }

    // Display focus group results
    async function displayFocusGroupResults(result) {
      console.log('Displaying results:', result); // Debug log
      
      const data = result.results || result; // Handle nested results
      const rounds = data.rounds || [];
      const simulationId = result.simulation_id;
      
      // Initialize chat messages array with all rounds
      chatMessagesArray = [];
      rounds.forEach((round, roundIndex) => {
        if (round.question || round.stimulus) {
          chatMessagesArray.push({
            type: 'moderator',
            text: round.question || round.stimulus,
            round_number: round.round_number || roundIndex + 1,
            isStimulus: !!round.stimulus
          });
        }
        if (round.responses) {
          round.responses.forEach((response, responseIndex) => {
            chatMessagesArray.push({
              type: 'participant',
              text: response.response,
              participant: responseIndex + 1,
              sentiment: response.sentiment || ''
            });
          });
        }
      });
      
      // Collect all responses from all rounds
      let allResponses = [];
      rounds.forEach(round => {
        if (round.responses) {
          allResponses = allResponses.concat(round.responses.map(r => ({
            ...r,
            round_type: round.round_type,
            question: round.question || round.stimulus
          })));
        }
      });
      
      // Check if open discussion is enabled
      const openDiscussion = document.getElementById('open-discussion').checked;
      
      // Create chat interface
      const resultsHtml = `
        <div class="flex h-screen bg-transparent">
          <!-- Main chat area -->
          <div class="flex-1 flex flex-col">
            <!-- Header -->
            <div class="glass-card p-4 mb-4">
              <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Focus Group Discussion</h2>
                <!-- Removed unwanted buttons. Leave space for future Data button. -->
              </div>
            </div>
            
                         <!-- Chat messages -->
             <div class="glass-card flex-1 flex flex-col">
               <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                 <!-- Chat messages will be rendered via renderChatMessages() -->
               </div>
              
              ${openDiscussion ? `
                <!-- Chat input -->
                <div class="border-t border-white/20 p-4">
                  <div class="flex space-x-2">
                    <input 
                      type="text" 
                      id="chat-input" 
                      placeholder="Continue the discussion..." 
                      class="flex-1 px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                      onkeypress="if(event.key==='Enter') sendMessage()"
                    >
                    <button 
                      onclick="sendMessage()" 
                      class="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition font-semibold"
                    >
                      Send
                    </button>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
          
                </div>
          
          <!-- Data button container (hidden initially) - moved below chat -->
          <div id="data-btn-container" class="flex justify-center mt-6 p-4" style="display: none;">
            <button id="data-btn" class="px-8 py-3 bg-white/30 backdrop-blur-md text-indigo-700 font-semibold rounded-lg shadow-lg border border-white/40 hover:bg-white/50 transition text-lg">
              üìä Review Data & Analytics
            </button>
          </div>
        </div>
    </div>
      `;
      
      // Replace current content with chat interface
      document.querySelector('main').innerHTML = resultsHtml;
      
      // Store simulation ID for continuing conversation
      window.currentSimulationId = simulationId;
      
      // Store analytics data for the analytics page
      if (result.analytics) {
        sessionStorage.setItem('focusGroupAnalytics', JSON.stringify(result.analytics));
        
        // Create transcript for download
        const transcript = allResponses.map(response => ({
          role: 'participant',
          persona_name: response.persona_description,
          content: response.response,
          sentiment: response.sentiment
        }));
        sessionStorage.setItem('focusGroupTranscript', JSON.stringify(transcript));
      }
      
      // Render the initial chat messages using glassmorphism
      renderChatMessages();

      // Show data button after session ends
      if (result.status === 'completed' || (result.results && result.results.rounds && result.results.rounds.length === 0)) {
        document.getElementById('data-btn-container').style.display = 'flex';
      }
      document.getElementById('data-btn')?.addEventListener('click', function() {
        window.open('/data', '_blank');
      });

      // Automatically progress through remaining questions
      async function progressThroughQuestions() {
        while (true) {
          const response = await fetch(`/api/focus_group/continue/${simulationId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          });
          const result = await response.json();
          if (result.status === 'success' && result.round) {
            // Add new round to chat messages array
            const round = result.round;
            if (round.question) {
              chatMessagesArray.push({
                type: 'moderator',
                text: round.question,
                round_number: round.round_number,
                isStimulus: false
              });
            }
            if (round.responses) {
              round.responses.forEach((response, responseIndex) => {
                chatMessagesArray.push({
                  type: 'participant',
                  text: response.response,
                  participant: responseIndex + 1,
                  sentiment: response.sentiment || ''
                });
              });
            }
            // Re-render all chat messages with glassmorphism
            renderChatMessages();
          } else {
            // All questions done, show Data button
            document.getElementById('data-btn-container').style.display = 'flex';
            break;
          }
        }
      }
      // Only run if there are more questions (i.e., if backend has more rounds to serve)
      setTimeout(progressThroughQuestions, 500);
    }
    
    // Send new message to continue discussion
    async function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      
      if (!message || !window.currentSimulationId) return;
      
      // Clear input
      input.value = '';
      
      // Add moderator message to chat
      const chatMessages = document.getElementById('chat-messages');
      const moderatorDiv = document.createElement('div');
      moderatorDiv.className = 'flex items-start space-x-3';
      moderatorDiv.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-400 to-cyan-400 flex items-center justify-center text-white font-bold text-sm">
          M
        </div>
        <div class="flex-1">
          <div class="bg-blue-50 rounded-lg p-3 shadow-sm">
            <div class="font-semibold text-sm text-gray-600 mb-1">Moderator</div>
            <div class="text-gray-800">${message}</div>
          </div>
        </div>
      `;
      chatMessages.appendChild(moderatorDiv);
      
      // Show loading indicator
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'text-center py-4';
      loadingDiv.innerHTML = '<div class="text-gray-500">üí≠ Participants are responding...</div>';
      chatMessages.appendChild(loadingDiv);
      
      // Auto-scroll
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      try {
        // Send to backend
        const response = await fetch(`/api/focus_group/continue/${window.currentSimulationId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: message })
        });
        
        const result = await response.json();
        
        // Remove loading indicator
        chatMessages.removeChild(loadingDiv);
        
        if (response.ok && result.status === 'success') {
          // Add responses to chat
          result.responses.forEach(response => {
            const responseDiv = document.createElement('div');
            responseDiv.className = 'flex items-start space-x-3';
            responseDiv.innerHTML = `
              <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-400 to-pink-400 flex items-center justify-center text-white font-bold text-sm">
                P
              </div>
              <div class="flex-1">
                <div class="bg-white/70 rounded-lg p-3 shadow-sm">
                  <div class="font-semibold text-sm text-gray-600 mb-1">
                    Participant
                    ${response.demographics ? ` ‚Ä¢ ${response.demographics.age}yo ${response.demographics.occupation}` : ''}
                  </div>
                  <div class="text-gray-800">${response.response}</div>
                  ${response.sentiment ? `<div class="text-xs text-gray-500 mt-1">Sentiment: ${response.sentiment}</div>` : ''}
                </div>
              </div>
            `;
            chatMessages.appendChild(responseDiv);
          });
        } else {
          // Show error
          const errorDiv = document.createElement('div');
          errorDiv.className = 'text-center py-4 text-red-500';
          errorDiv.textContent = 'Error: ' + (result.error || 'Failed to get responses');
          chatMessages.appendChild(errorDiv);
        }
        
      } catch (error) {
        // Remove loading indicator
        chatMessages.removeChild(loadingDiv);
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-center py-4 text-red-500';
        errorDiv.textContent = 'Error: ' + error.message;
        chatMessages.appendChild(errorDiv);
      }
      
      // Auto-scroll to bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Generate analysis of the discussion
    async function generateAnalysis() {
      const analysisPanel = document.getElementById('analysis-panel');
      const analysisContent = document.getElementById('analysis-content');
      
      // Show panel
      analysisPanel.classList.remove('hidden');
      
      // Show loading
      analysisContent.innerHTML = '<div class="text-gray-600">ü§ñ Analyzing discussion...</div>';
      
      try {
        // Get all chat messages for analysis
        const chatMessages = document.getElementById('chat-messages');
        const messages = Array.from(chatMessages.children).map(div => {
          const text = div.querySelector('.text-gray-800');
          const name = div.querySelector('.font-semibold');
          return {
            speaker: name ? name.textContent.split(' ‚Ä¢')[0] : 'Unknown',
            message: text ? text.textContent : ''
          };
        }).filter(m => m.message);
        
        // TODO: Send to AI for analysis
        // For now, generate basic analysis
        const analysisHtml = `
          <div class="space-y-4">
            <div class="bg-white/50 p-3 rounded-lg">
              <h4 class="font-semibold mb-2">üìä Key Insights</h4>
              <ul class="text-sm space-y-1">
                <li>‚Ä¢ ${messages.length} total responses collected</li>
                <li>‚Ä¢ Active participation from all personas</li>
                <li>‚Ä¢ Mixed sentiment patterns observed</li>
              </ul>
            </div>
            
            <div class="bg-white/50 p-3 rounded-lg">
              <h4 class="font-semibold mb-2">üí≠ Common Themes</h4>
              <div class="text-sm space-y-1">
                <div class="bg-blue-100 px-2 py-1 rounded">User Experience</div>
                <div class="bg-green-100 px-2 py-1 rounded">Value Proposition</div>
                <div class="bg-yellow-100 px-2 py-1 rounded">Concerns</div>
              </div>
            </div>
            
            <div class="bg-white/50 p-3 rounded-lg">
              <h4 class="font-semibold mb-2">üìà Recommendations</h4>
              <ul class="text-sm space-y-1">
                <li>‚Ä¢ Address pricing concerns</li>
                <li>‚Ä¢ Emphasize unique benefits</li>
                <li>‚Ä¢ Improve clarity of messaging</li>
              </ul>
            </div>
          </div>
        `;
        
        analysisContent.innerHTML = analysisHtml;
        
      } catch (error) {
        analysisContent.innerHTML = `<div class="text-red-500">Error generating analysis: ${error.message}</div>`;
      }
    }
    
    // Check if configuration is complete to enable questions section
    function checkConfigurationComplete() {
      const groupSize = document.getElementById('group-size').value;
      const questionCount = document.getElementById('question-count').value;
      const openDiscussion = document.getElementById('open-discussion').checked;
      const nextButton = document.getElementById('next-button');
      const questionsSection = document.getElementById('questions-section');
      const placeholderSection = document.getElementById('placeholder-section');
      
      // All fields are considered complete if they have values (checkbox can be unchecked)
      const isComplete = groupSize && questionCount;
      
      if (isComplete) {
        // Show questions section and hide placeholder
        questionsSection.classList.remove('hidden');
        placeholderSection.classList.add('hidden');
        
        // Enable next button
        nextButton.disabled = false;
        nextButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
        nextButton.classList.add('bg-indigo-500', 'hover:bg-indigo-600', 'cursor-pointer');
        } else {
        // Show placeholder and hide questions section
        questionsSection.classList.add('hidden');
        placeholderSection.classList.remove('hidden');
        
        // Disable next button
        nextButton.disabled = true;
        nextButton.classList.add('bg-gray-400', 'cursor-not-allowed');
        nextButton.classList.remove('bg-indigo-500', 'hover:bg-indigo-600', 'cursor-pointer');
      }
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Set default selected audience
      const defaultCard = document.querySelector('.audience-card input[checked]').closest('.audience-card');
      defaultCard.classList.add('selected');
      
      // Check initial configuration state
      checkConfigurationComplete();
    });
  </script>
</body>
</html>